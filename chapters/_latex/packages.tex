%\usepackage[a-1b]{pdfx}  % to create a PDF/A
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fix-cm}
\usepackage{microtype}  % better justifications, amongst others
\usepackage{longtable,booktabs}

% Make hyperref silent, it's always complaining for tokens like \beta
\usepackage{silence}

\usepackage[unicode=true,pdfa]{hyperref}  % already loaded by pdfx
\hypersetup{breaklinks=true,  % not compatible with pdf/a
            pdfauthor={Maël Le Garrec},
            pdftitle={LHC Effective Model for Optics Corrections},
            colorlinks=true,
            citecolor=blue,
            urlcolor=blue,
            linkcolor=black,
            pdfborder={0 0 0}}
\usepackage[capitalise]{cleveref}
\usepackage[english]{babel}

% == FONTS
\usepackage{calligra}  % font for quote page
%\usepackage{libertinust1math}
\usepackage[libertine]{newtxmath}  % needs to be loaded before libertine
\usepackage{libertine}             % font for the whole document
%\usepackage{lmodern}  % font based on Computer Modern for the whole doc
% ==

\usepackage{pdfpages} % to include .pdf files, for CV
\usepackage{ifthen}
\usepackage{wasysym}
\usepackage{enumitem}  % to define new lists
\usepackage{tikz}  % for drawing figures by code
\usepackage{siunitx}
\usepackage{graphicx}
\usepackage{caption}
\usepackage{ragged2e}
\usepackage{atveryend}
\usepackage{subcaption}
\usepackage{pgf}  % fileformat for the flipbook
\usepackage{xcolor,soul}
\usepackage{lscape}  % landscape
\usepackage{changepage}
\usepackage[nonumberlist,acronyms,nogroupskip,nopostdot]{glossaries}
\usepackage{glossary-longbooktabs}
\usepackage{setspace}
\usepackage[english]{babel}
\usepackage{float}
\usepackage{titletoc}
\usepackage{etoc}  % local tables of content
\usepackage{imakeidx}
\usepackage{lipsum}
\usepackage{geometry}
\usepackage[automark]{scrlayer-scrpage} % for headers and footers
\usepackage{scrhack}  % to remove some warnings
\usepackage{blindtext}
\usepackage{amsmath}
\usepackage{mathtools}  % for some functions, like DeclarePairedDelimiter
\usepackage{svg}
\usepackage{multirow}
\usepackage{wrapfig}
\usepackage{nicematrix}
\usepackage{placeins} % for the \FloatBarrier
\usepackage{arydshln}  % dashed lines in tables
\usepackage[%
  backend=bibtex        % biber or bibtex
%,style=authoryear      % Alphabeticalsch
 ,style=numeric-comp    % numerical-compressed
 ,sorting=none          % no sorting
 ,sortcites=true        % some other example options ...
 ,block=none
 ,indexing=false
 ,citereset=none
 ,isbn=false
 ,url=true
 ,doi=true              % prints doi
 ,natbib=true           % if you need natbib functions
]{biblatex}
\AtEveryBibitem{%  % in the bibliography
    \clearlist{language}%  % remove language from citations
    \clearfield{urlyear}%  % to remove the "visited on"
    \clearfield{urlmonth}%
    \clearfield{urlday}%
    \clearfield{day}%  % only print the year
    \clearfield{month}%
    \clearfield{endday}%
    \clearfield{endmonth}%
    \clearfield{note}%  % information about the PDF, like size and number of pages
    \clearfield{pages}%  % which pages in the book
}
\AtEveryCitekey{%  % for \fullcite
    \clearlist{language}%
    \clearfield{urlyear}%
    \clearfield{urlmonth}%
    \clearfield{day}%
    \clearfield{month}%
    \clearfield{endday}%
    \clearfield{endmonth}%
    \clearfield{note}%
    \clearfield{pages}%
}
\addbibresource{library.bib}  % better than \bibliography
\addbibresource{manual-library.bib}  % manually added references
\usepackage{csquotes}  % Changes the quotestyle depending on the language, useful for bibliography



% ===========================================================================
%                               Flip Book
% ===========================================================================
\usepackage{chapters/_latex/flipbook}
% Footer with the flipbook and pagemarks
%\rofoot*{% Odd pages footer aligned to right
%  \flipbookframe[1][1]{../flipbook/frames/frame_}[pgf][0.2]%
%    % start frame
%    % speed of the animation per page
%    % scale
%  \parbox{30pt}{%
%    \raggedleft%
%    \pagemark%
%  }%
%}
%\lefoot*{% Even pages footer aligned to left
%  \parbox{30pt}{%
%    \raggedright%
%    \pagemark%
%  }%
%  \flipbookframe[1][1]{../flipbook/frames/frame_}[pgf][0.2]%
%} 


% ===========================================================================
%                            General Options
% ===========================================================================

% Set the geometry of the pages and the fontsize
% For a twoside book like this one, `left` and `right` mean respectively `inner` and `outer`
% The numbers are based on the "Canon des Ateliers", https://etnadji.fr/rsc/canon/calcul.php
% https://www.alain.les-hurtig.org/varia/empagement.html
%
% tête = top, pied = bottom, petit fond = left, grand fond = right
\newcommand{\papersize}{A4}  % Set the size of the page, also used later in the thesis
%
\ifthenelse{\equal{\papersize}{A4}}{ % A4
  \geometry{a4paper, top=2.625cm, left=2.1cm, right=3.15cm, bottom=3.675cm, includehead, includefoot}
  \KOMAoptions{fontsize=11pt}  % that's the default anyways
}{
  \ifthenelse{\equal{\papersize}{B5}}{
    \geometry{paperheight=235mm, paperwidth=165mm,   % printhub.eu "B5" paper
              top=20.625mm, bottom=28.875mm, left=16.5mm, right=24.75mm,
              includehead, includefoot} % courant
    \KOMAoptions{fontsize=10pt}
  }{ % else, A5
    \geometry{paperheight=210mm, paperwidth=148mm,
              top=18.5mm, bottom=25.9mm, left=14.8mm, right=22.2mm,
              includehead, includefoot} % courant
    \KOMAoptions{fontsize=9pt}
  }
}

% Vertical space before chapters
\RedeclareSectionCommand[beforeskip=5pt, afterskip=2cm]{chapter}

% Factor spacing between lines
\linespread{1.1}

\numberwithin{equation}{chapter}
\numberwithin{table}{chapter}
\numberwithin{figure}{chapter}
\newcommand*\diff{\mathop{}\!\mathrm{d}}

% Set some lengths
\setlength{\parindent}{12pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\setcounter{secnumdepth}{2}  %  set up to which point a sub[..]subsection is numbered

\urlstyle{same}  % don't use monospace font for urls

% Make the captions closer to table, figures, etC.
%\setlength{\belowcaptionskip}{-5pt}
%\setlength{\abovecaptionskip}{-5pt}

% LaTeX will stretch the page to fit vertically on the whole page as part of the "book" style
% This prevents it
\raggedbottom


% ===========================================================================
%                            Some commands
% ===========================================================================

% Create a \tightlight command for itemize environments to have the bullet points closer together
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% Command to create highlights easily in colors
\DeclareRobustCommand{\hlcyan}[1]{{\sethlcolor{cyan}\hl{#1}}}

% Display a table of contents for the current chapter
\newcommand{\chaptertoc}[1][Contents]{%
  % Set the indent so it's a bit tighter and looks better
  %\setlength{\cftsecindent}{0.2cm}
  %\setlength{\cftsubsecindent}{0.8cm}
  %\setlength{\cftsubsubsecindent}{1.4cm}

  %\etocmulticolstyle{\addsec*{#1\\\rule{\textwidth}{0.4pt}}}%
  \setcounter{tocdepth}{5}

  % Reduce the spacing between the list items
  %\addsec*{\rule{\textwidth}{0.4pt}}
  \begin{spacing}{0.1}
    \localtableofcontents%
  \end{spacing}
}

% When using align from amsmath, each line is numbered
% This allows to use align* and the manually number the last equation
\newcommand\numberthis{\addtocounter{equation}{1}\tag{\theequation}}

% Some commands to display text in color
% To do in red
\newcommand*{\todo}[1]{{\bfseries\color{red}#1}}
% To be reviewed in orange
%\newcommand*{\review}[1]{{\bfseries\color{orange}#1}}
\newcommand*{\review}[1]{#1}
% Machine proofread
%\newcommand*{\mread}[1]{{\bfseries\color{olive}#1}}
\newcommand*{\mread}[1]{#1}
% OK in green
\newcommand*{\done}[1]{{\bfseries\color{green}#1}}

% For commands floor and ceil to be easier to type
\DeclarePairedDelimiter\ceil{\lceil}{\rceil}
\DeclarePairedDelimiter\floor{\lfloor}{\rfloor}



% ===========================================================================
%                                Fonts
% ===========================================================================
% Font for the main title, chapter and sections titles
\newfontfamily{\chapterfont}{Tex Gyre Adventor}
\newfontfamily{\subtitlefont}{Tex Gyre Adventor}
% fontsize for the overall chapter's definition, sets the line reference size, etc.
\setkomafont{chapter}{\LARGE}
% fontsize for the number in the box
\setkomafont{chapterprefix}{\Huge}
% fonts for the sections, subsections etc
\setkomafont{section}{\chapterfont\Large\bfseries}
\setkomafont{subsection}{\chapterfont\large\bfseries}
\setkomafont{subsubsection}{\chapterfont\normalsize\bfseries}
\setkomafont{paragraph}{\chapterfont\small\bfseries}
\setkomafont{pagenumber}{\normalfont\chapterfont\small}
% fonts for the TOC
\setkomafont{disposition}{\normalfont\chapterfont}
\RedeclareSectionCommands[
  tocentryformat=\usekomafont{disposition}\bfseries,
  tocpagenumberformat=\usekomafont{disposition}\bfseries
]{part,chapter,section,subsection,subsubsection}
\RedeclareSectionCommands[
  tocentryformat=\usekomafont{disposition},
  tocpagenumberformat=\usekomafont{disposition}
]{section,subsection,subsubsection,paragraph,subparagraph}
\RedeclareSectionCommands[
  tocentryformat=\usekomafont{disposition},
  tocpagenumberformat=\usekomafont{disposition}
]{paragraph,subparagraph}
% Remove the dots and put the number right next to the text
% Not for chapters
\RedeclareSectionCommands[
  toclinefill=\hspace{1em}/\hspace{1em},  % set the distance between the text and page number
  tocpagenumberbox=\raggedleft,  % align the page number left, to have the same space before and after the /
  tocraggedpagenumber=true,  % unforce the pagenumber to be justified right
]{section,subsection,subsubsection,paragraph,subparagraph}



% ===========================================================================
%                      Nice looking chapters headings
% ===========================================================================
\renewcommand*{\chapterformat}{\thechapter}
\renewcommand*{\raggedchapter}{\raggedleft}
\newcommand*{\ChapterCase}[1]{#1}
\newsavebox\chapternumberbox
\renewcommand*{\chapterlinesformat}[3]{% #1 = chapter command name
                                       % #2 = number (or empty)
                                       % #3 = text
  \begin{minipage}{\textwidth}
  % Line                                       
  \vspace{1pt}\rule{\linewidth}{1pt}% First rule
  \vspace{-18pt} % Small vertical space between the rules
  \rule{\linewidth}{1pt}% Second rule
  %\rule[-\dp\strutbox]{\linewidth}{.4pt}%
  %
  % Create the box
  \sbox\chapternumberbox
  {%
    \makebox[0pt][l]{%
      \hspace{-\linewidth}\hspace{2em}% spacing of the box from the left
      %
      \colorbox{black}{%
        \parbox[c][1.5em][c]{1.5em}{%
          \centering
          \textcolor{white}{%
            \usekomafont{chapterprefix}{%
              \vspace{-0.2em}%
              \strut #2%
            }%
          }%
          \par
        }%
      }%
    }%
  }%
  % And now place it, if the chapter is numbered
  \IfArgIsEmpty{#2}{%
    \vphantom{\usebox\chapternumberbox}%
  }{%
    \usebox\chapternumberbox%
    \par
  }%
  \vspace{0.5em}
  % Display the chapter's title
  %\hspace{2em}
  \begin{flushright}%
    \parbox{0.85\textwidth}{%
      \raggedright% deactivate wrapping, align to the left
      %\raggedleft% deactivate wrapping, align to the right
      \ChapterCase{%
          \strut\ignorespaces\chapterfont\fontsize{30pt}{30pt}\selectfont\bfseries #3%
      }%
    }%
  \end{flushright}%
  \par
  % Line
  \vspace{.5em}
  \rule[.5em]{\linewidth}{1.2pt}
  \par
  \end{minipage}
}


% ===========================================================================
%                            Chapter Thumbs
% ===========================================================================
% chapterthumbs.sty from KOMA script adapted by jdilly to use tikz according to 
% https://tex.stackexchange.com/questions/526904/scrreprt-thumb-indices-with-scrlayer-scrpage-use-any-shape-as-chapterthumb
% original example in https://komascript.de/komascriptbuch7examples 
\usepackage{tikz}
\newlength{\chapterthumbwidth}
\newlength{\chapterthumbheight}
\definecolor{thumb_color}{HTML}{999999}  % That's a kind of grey

\newcommand*{\firstchapterthumbskip}{.1\paperheight}
\newcommand*{\lastchapterthumbskip}{\firstchapterthumbskip}
\setlength{\chapterthumbheight}{4.5em}
\setlength{\chapterthumbwidth}{.06\paperwidth}
% This value below is the distance between thumbs. Originally hardcoded to 0.1.
% Modified here fit to all the chapters on one pageheight, and then wrap around at the top for
% appendices
\newcommand*{\chapterthumbskip}{.105\paperheight} % (1 - (0.1) * 2 ) / nchapters
\colorlet{chapterthumbboxcolor}{thumb_color}
\newcommand*{\chapterthumbcolor}{white}
\newcommand*{\chapterthumbformat}{\thechapter} % What's written in the box
\newkomafont{chapterthumb}{\normalfont\chapterfont\Large\color{\chapterthumbcolor}}
\usetikzlibrary{shapes.misc, positioning}

\makeatletter
% TIKZ Style
\newcommand*\chapterthumb@box{%
  \usekomafont{chapterthumb}%
    \parbox[c][\chapterthumbheight][c]{\chapterthumbwidth}{%
      \centering
      \begin{tikzpicture} 
        % second rectangle to hide rounded corner on page border
        \ifodd\value{page}
            \node[rectangle, 
                fill=chapterthumbboxcolor,
                minimum width=0.9\chapterthumbwidth, 
                minimum height=\chapterthumbheight,
                ] at (0.1,0){};
        \else
            \node[rectangle, 
                fill=chapterthumbboxcolor,
                minimum width=0.9\chapterthumbwidth, 
                minimum height=\chapterthumbheight,
                ] at (-0.1,0){};
        \fi
        % rectangle with content
        \node[rectangle, 
              fill=chapterthumbboxcolor,
              minimum width=\chapterthumbwidth, 
              minimum height=\chapterthumbheight,
              rounded corners=2pt,
              ] at (0,0){\chapterthumbformat};
      \end{tikzpicture}%
    }%
}

\newcommand*{\chapterthumbbox}{%
    \if@mainmatter
    \ifnum\value{chapter}>\z@
    \ifnum \value{chapterthumb}<\z@
    \else
    \begingroup
    \protected@edef\reserved@a{\chapterthumbformat}%
    \ifx\reserved@a\lastchapterthumbformat\else
    \stepcounter{chapterthumb}%
    \global\let\lastchapterthumbformat\reserved@a
    \fi
    \@tempcnta=\numexpr
    \dimexpr
    \paperheight
    -\firstchapterthumbskip
    -\chapterthumbwidth
    -\lastchapterthumbskip
    \relax / \dimexpr
    \chapterthumbskip
    \relax
    +1
    \relax
    \ifnum \value{chapterthumb}<\@tempcnta
    \else
    \setcounter{chapterthumb}{0}%
    \fi
    \vspace*{%
        \dimexpr
      \firstchapterthumbskip
        + ( \chapterthumbskip )
        * \value{chapterthumb}%
        - \baselineskip
        \relax
    }\par
    \setlength{\fboxsep}{0pt}%
    \ifodd\value{page}
    \hfill
    \makebox[0pt][r]{\chapterthumb@box}%
    \else
    \makebox[0pt][l]{\chapterthumb@box}%
    \fi
    \endgroup
    \fi
    \fi
    \fi
}
\makeatother

\newcounter{chapterthumb}
\setcounter{chapterthumb}{10000}
\newcommand*{\lastchapterthumbformat}{\relax}

\DeclareNewLayer[%
background,%
outermargin,%
% oddpage,%
% rightmargin,%
contents=\chapterthumbbox
]{chapterthumb}

\newcommand*\EnableChapterthumb{%
    \IfLayerAtPageStyle{scrheadings}{chapterthumb}{}
    {\AddLayersToPageStyle{@everystyle@}{chapterthumb}}%
}
\newcommand*\DisableChapterthumb{%
    \RemoveLayersFromPageStyle{@everystyle@}{chapterthumb}%
}

% Only add the thumb on some pages. Avoid for example the Part style for Appendices
%\newpairofpagestyles[scrheadings]{part}{}
%\renewcommand\partpagestyle{plain.part}
%\AddLayersToPageStyle{scrheadings}{chapterthumb}
%\AddLayersToPageStyle{plain.scrheadings}{chapterthumb}